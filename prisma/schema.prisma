// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum QuizType {
  STANDARD
  QUICK_CHECK
  TIMED_TEST
  SCENARIO_BASED
  CONFIDENCE_BASED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  password      String?
  avatar        String?
  googleId      String?  @unique
  accessToken   String?
  refreshToken  String?
  schoolName    String?
  schoolId      String?
  school        School?  @relation(fields: [schoolId], references: [id])
  grade         String?
  role          UserRole @default(USER)
  isActive      Boolean  @default(true)
  onboardingCompleted Boolean @default(false)
  onboardingAssessmentCompleted Boolean @default(false)
  assessmentPopupShown Boolean @default(false)
  preferences   Json?    // Store user preferences as JSON
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quizzes       Quiz[]
  flashcardSets FlashcardSet[]
  attempts      Attempt[]
  streak        Streak?
  leaderboard   LeaderboardEntry[]
  contents      Content[]
  highlights    Highlight[]
  tasks         Task[]
  topicProgress TopicProgress[]
  fcmTokens     String[] @default([])
  reports       Report[]

  @@map("users")
}

model Quiz {
  id          String   @id @default(uuid())
  title       String
  topic       String
  difficulty  String   @default("medium")
  quizType    QuizType @default(STANDARD)
  tags        String[] @default([])
  timeLimit   Int?     // Time limit in seconds (for timed quizzes)
  questions   Json     // Store questions array as JSON
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceType  String?  // "text" or "file"
  sourceFiles String[] // Array of file paths if generated from files
  contentId   String?  @unique
  content     Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempts    Attempt[]
  challenges  Challenge[]
  challengeQuizzes ChallengeQuiz[]
  reports     Report[]

  @@map("quizzes")
  @@index([userId])
  @@index([createdAt])
}

model FlashcardSet {
  id          String   @id @default(uuid())
  title       String
  topic       String
  cards       Json     // Store flashcards array as JSON
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceType  String?  // "text", "file", or "topic"
  sourceFiles String[] // Array of file paths if generated from files
  contentId   String?  @unique
  content     Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempts    Attempt[]

  @@map("flashcard_sets")
  @@index([userId])
  @@index([createdAt])
}

model Streak {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActivityDate DateTime @default(now())
  totalXP          Int      @default(0)
  level            Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("streaks")
}

model LeaderboardEntry {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  score     Int      @default(0)
  rank      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@map("leaderboard_entries")
  @@index([score])
  @@index([rank])
}

enum ChallengeType {
  DAILY
  WEEKLY
  MONTHLY
  HOT
}

model Challenge {
  id          String   @id @default(uuid())
  title       String
  description String
  type        String   // "daily", "weekly", "monthly", "hot"
  category    String?  // More explicit categorization (e.g., "Daily Challenges", "Weekly Challenges")
  target      Int
  reward      Int
  startDate   DateTime
  endDate     DateTime
  rules       String?  @db.Text // Challenge-specific rules
  timeLimit   Int?     // Overall time limit for the challenge in seconds
  maxParticipants Int? // Maximum number of participants allowed (10-100)
  format      String   @default("STANDARD") // "TIMED", "SCENARIO", "SPEED", "ACCURACY", "MIXED"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  completions ChallengeCompletion[]
  quizzes     ChallengeQuiz[]
  attempts    Attempt[]

  // Legacy single quiz support (deprecated, use quizzes relation)
  quizId      String?
  quiz        Quiz?    @relation(fields: [quizId], references: [id])

  @@map("challenges")
  @@index([type])
  @@index([endDate])
  @@index([category])
}

model ChallengeCompletion {
  id              String    @id @default(uuid())
  challengeId     String
  challenge       Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId          String
  progress        Int       @default(0)
  completed       Boolean   @default(false)
  completedAt     DateTime?
  currentQuizIndex Int      @default(0) // Current quiz index in multi-quiz challenges
  quizAttempts    Json?     // Array of quiz attempt results
  finalScore      Int?      // Cumulative score across all quizzes
  percentile      Float?    // User's percentile ranking (0-100)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([challengeId, userId])
  @@map("challenge_completions")
  @@index([userId])
  @@index([completed])
}

model ChallengeQuiz {
  id          String    @id @default(uuid())
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  order       Int       // Order of quiz in the challenge sequence (0-indexed)
  createdAt   DateTime  @default(now())
  
  @@unique([challengeId, quizId])
  @@unique([challengeId, order])
  @@map("challenge_quizzes")
  @@index([challengeId])
  @@index([quizId])
}


model Attempt {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId         String?
  flashcardSetId String?
  challengeId    String?
  type           String        // "quiz", "flashcard", "challenge"
  score          Int?
  totalQuestions Int?
  answers        Json?         // Store user answers
  confidenceRatings Json?      // Store confidence ratings for each answer
  timeSpent      Int?          // Time spent in seconds
  completedAt    DateTime      @default(now())
  createdAt      DateTime      @default(now())

  quiz           Quiz?         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  flashcardSet   FlashcardSet? @relation(fields: [flashcardSetId], references: [id], onDelete: Cascade)
  challenge      Challenge?    @relation(fields: [challengeId], references: [id], onDelete: SetNull)

  @@map("attempts")
  @@index([userId])
  @@index([quizId])
  @@index([flashcardSetId])
  @@index([challengeId])
  @@index([completedAt])
}

model Recommendation {
  id        String   @id @default(uuid())
  userId    String
  topic     String
  reason    String
  priority  String   // "high", "medium", "low"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, topic])
  @@map("recommendations")
  @@index([userId])
  @@index([priority])
}

model Content {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  learningGuide Json?    // Store structured learning guide
  topic       String
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  highlights  Highlight[]
  quiz        Quiz?
  flashcardSet FlashcardSet?
  quizId        String?
  flashcardSetId String?
  lastReadPosition Float    @default(0)
  topicProgress TopicProgress[]
  reports       Report[]

  @@map("contents")
  @@index([userId])
}

model Highlight {
  id        String   @id @default(uuid())
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String
  color     String   @default("yellow")
  startOffset Int
  endOffset   Int
  note      String?
  sectionIndex Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("highlights")
  @@index([contentId])
  @@index([userId])
}

enum TaskStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TaskType {
  ONBOARDING_ASSESSMENT
  CONTENT_GENERATION
}

model Task {
  id        String     @id @default(uuid())
  userId    String
  type      TaskType
  status    TaskStatus @default(PENDING)
  result    Json?      // Store the result (e.g. contentId)
  error     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("tasks")
  @@index([userId])
}

enum RetentionLevel {
  LEARNING
  REINFORCEMENT
  RECALL
  MASTERY
}

model TopicProgress {
  id             String         @id @default(uuid())
  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic          String
  retentionLevel RetentionLevel @default(LEARNING)
  strength       Int            @default(0) // 0-100
  lastReviewedAt DateTime       @default(now())
  nextReviewAt   DateTime       @default(now())
  contentId      String?
  content        Content?       @relation(fields: [contentId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([userId, topic])
  @@map("topic_progress")
  @@index([userId])
  @@index([nextReviewAt])
  @@index([retentionLevel])
}

model QuizRecommendation {
  id          String   @id @default(uuid())
  userId      String
  quizType    QuizType
  topic       String
  difficulty  String
  reason      String   @db.Text
  priority    String   // "high", "medium", "low"
  scheduledFor DateTime?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("quiz_recommendations")
  @@index([userId])
  @@index([completed])
  @@index([scheduledFor])
  @@index([priority])
}

model WeakArea {
  id          String   @id @default(uuid())
  userId      String
  topic       String
  concept     String   // Specific concept within the topic
  errorCount  Int      @default(1)
  lastErrorAt DateTime @default(now())
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, topic, concept])
  @@map("weak_areas")
  @@index([userId])
  @@index([resolved])
  @@index([topic])
}

model StudySession {
  id          String   @id @default(uuid())
  userId      String
  type        String   // "quiz", "flashcard", "content_review"
  duration    Int      // Duration in seconds
  itemsStudied Int     // Number of items studied
  performance Float?   // Performance score (0-100)
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  createdAt   DateTime @default(now())

  @@map("study_sessions")
  @@index([userId])
  @@index([startedAt])
  @@index([type])
}


model School {
  id        String   @id @default(uuid())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("schools")
  @@index([name])
}

model Report {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contentId String?
  content   Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  quizId    String?
  quiz      Quiz?    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  reason    String
  status    String   @default("PENDING") // PENDING, RESOLVED, IGNORED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reports")
  @@index([userId])
  @@index([status])
}

model Document {
  id               String   @id @default(uuid())
  hash             String   @unique
  cloudinaryUrl    String
  cloudinaryId     String
  googleFileUrl    String?
  googleFileId     String?
  fileName         String
  mimeType         String
  sizeBytes        Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("documents")
  @@index([hash])
}

model PlatformSettings {
  id                String   @id @default(uuid())
  allowRegistration Boolean  @default(true)
  maintenanceMode   Boolean  @default(false)
  supportEmail      String?
  aiPrompts         Json?
  updatedAt         DateTime @updatedAt

  @@map("platform_settings")
}
